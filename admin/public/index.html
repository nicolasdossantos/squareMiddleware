<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tenant Onboarding - Square Middleware</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Tenant Onboarding</h1>
        <p class="text-gray-600 mt-2">Add new agents to the Square Middleware system</p>
      </div>

      <!-- Existing Tenants -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Existing Tenants</h2>
        <div id="tenantsList" class="space-y-2">
          <div class="text-gray-500 italic">Loading...</div>
        </div>
      </div>

      <!-- Onboarding Form -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Add New Tenant</h2>

        <form id="onboardingForm" class="space-y-4">
          <!-- Agent ID -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Agent ID <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              name="agentId"
              id="agentId"
              required
              placeholder="agent_895480dde586e4c3712bd4c770"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <!-- Business Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Business Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              name="businessName"
              id="businessName"
              required
              placeholder="Elite Barbershop"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <!-- Square Credentials -->
          <div class="border-t pt-4">
            <h3 class="font-semibold text-gray-800 mb-3">Square API Credentials</h3>

            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Square Access Token <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  name="squareAccessToken"
                  id="squareAccessToken"
                  required
                  placeholder="EAAAl..."
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Square Location ID <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="squareLocationId"
                  id="squareLocationId"
                  required
                  placeholder="L71YZWPR1TD9B"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                  Square Environment <span class="text-red-500">*</span>
                </label>
                <select
                  name="squareEnvironment"
                  id="squareEnvironment"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="production">Production</option>
                  <option value="sandbox">Sandbox</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Square Merchant ID</label>
                <input
                  type="text"
                  name="squareMerchantId"
                  id="squareMerchantId"
                  placeholder="MERCHANT_ID"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Default Location ID</label>
                <input
                  type="text"
                  name="defaultLocationId"
                  id="defaultLocationId"
                  placeholder="Optional override if different from Square Location ID"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Square Refresh Token</label>
                <textarea
                  name="squareRefreshToken"
                  id="squareRefreshToken"
                  rows="2"
                  placeholder="Paste refresh token from OAuth callback (optional)"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                ></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Token Expires At</label>
                <input
                  type="text"
                  name="squareTokenExpiresAt"
                  id="squareTokenExpiresAt"
                  placeholder="2025-01-01T00:00:00Z"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">OAuth Scopes</label>
                <input
                  type="text"
                  name="squareScopes"
                  id="squareScopes"
                  placeholder="APPOINTMENTS_READ,APPOINTMENTS_WRITE,CUSTOMERS_READ,CUSTOMERS_WRITE"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Supports Seller-Level Writes?
                </label>
                <select
                  name="supportsSellerLevelWrites"
                  id="supportsSellerLevelWrites"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">Select plan</option>
                  <option value="true">Yes – Appointments Plus/Premium</option>
                  <option value="false">No – Free plan (agent-created bookings only)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="border-t pt-4">
            <h3 class="font-semibold text-gray-800 mb-3">Contact Information</h3>

            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Contact Email <span class="text-red-500">*</span>
                </label>
                <input
                  type="email"
                  name="contactEmail"
                  id="contactEmail"
                  required
                  placeholder="hello@fluentfront.ai"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Contact Phone <span class="text-red-500">*</span>
                </label>
                <input
                  type="tel"
                  name="contactPhone"
                  id="contactPhone"
                  required
                  placeholder="+12677210098"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Timezone</label>
                <select
                  name="timezone"
                  id="timezone"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="America/New_York">America/New_York (ET)</option>
                  <option value="America/Chicago">America/Chicago (CT)</option>
                  <option value="America/Denver">America/Denver (MT)</option>
                  <option value="America/Los_Angeles">America/Los_Angeles (PT)</option>
                  <option value="America/Phoenix">America/Phoenix (MST)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Test Credentials Button -->
          <div class="flex gap-3 pt-4">
            <button
              type="button"
              id="testBtn"
              class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition"
            >
              Test Credentials
            </button>

            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-medium"
            >
              Create Tenant
            </button>
          </div>
        </form>

        <!-- Status Messages -->
        <div id="statusMessage" class="mt-4 hidden"></div>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;

      // Load existing tenants
      async function loadTenants() {
        try {
          const response = await fetch(`${API_BASE}/api/admin/tenants`);
          const data = await response.json();

          const list = document.getElementById('tenantsList');

          if (data.tenants && data.tenants.length > 0) {
            list.innerHTML = data.tenants
              .map(tenant => {
                const planLabel =
                  tenant.supportsSellerLevelWrites === true
                    ? 'Full access (seller-level writes)'
                    : tenant.supportsSellerLevelWrites === false
                    ? 'Agent-created bookings only (free plan)'
                    : 'Plan status unknown';
                const merchantLine = tenant.squareMerchantId
                  ? `<div class="mt-1 text-xs text-gray-400">Merchant ${tenant.squareMerchantId}</div>`
                  : '';
                const locationLine = tenant.defaultLocationId
                  ? `<div class="mt-1 text-xs text-gray-400">Location ${tenant.defaultLocationId}</div>`
                  : '';
                const oauthBadge = tenant.hasRefreshToken
                  ? '<div class="mt-1 inline-flex items-center px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full text-[11px]">OAuth connected</div>'
                  : '';

                return `
                  <div class="p-4 bg-gray-50 rounded border border-gray-200 flex justify-between gap-4">
                    <div>
                      <div class="flex items-center flex-wrap gap-2">
                        <span class="font-medium text-gray-800">${tenant.businessName}</span>
                        <span class="text-gray-500 text-xs">(${tenant.agentId})</span>
                      </div>
                      <div class="mt-1 text-xs text-gray-600">${planLabel}</div>
                      ${merchantLine}
                      ${locationLine}
                    </div>
                    <div class="text-right text-xs text-gray-500">
                      <div class="font-medium text-gray-600">${tenant.squareEnvironment}</div>
                      <div>${tenant.timezone}</div>
                      ${oauthBadge}
                    </div>
                  </div>
                `;
              })
              .join('');
          } else {
            list.innerHTML = '<div class="text-gray-500 italic">No tenants configured yet</div>';
          }
        } catch (error) {
          console.error('Failed to load tenants:', error);
          document.getElementById('tenantsList').innerHTML =
            '<div class="text-red-500">Failed to load tenants</div>';
        }
      }

      // Test credentials
      document.getElementById('testBtn').addEventListener('click', async () => {
        const btn = document.getElementById('testBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Testing...';
        btn.disabled = true;

        try {
          const formData = new FormData(document.getElementById('onboardingForm'));
          const data = Object.fromEntries(formData);

          const response = await fetch(`${API_BASE}/api/admin/test-credentials`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          showMessage(
            result.success
              ? `✅ Credentials valid! Found location: ${result.locationName}`
              : `❌ Test failed: ${result.error}`,
            result.success ? 'success' : 'error'
          );
        } catch (error) {
          showMessage(`❌ Test failed: ${error.message}`, 'error');
        } finally {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      });

      // Submit form
      document.getElementById('onboardingForm').addEventListener('submit', async e => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        try {
          const response = await fetch(`${API_BASE}/api/admin/onboard`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (result.success) {
            showMessage(`✅ Tenant created successfully!`, 'success');
            e.target.reset();
            loadTenants();
          } else {
            showMessage(`❌ Failed: ${result.error}`, 'error');
          }
        } catch (error) {
          showMessage(`❌ Error: ${error.message}`, 'error');
        }
      });

      function showMessage(message, type) {
        const div = document.getElementById('statusMessage');
        div.className = `mt-4 p-4 rounded-md ${
          type === 'success'
            ? 'bg-green-50 text-green-800 border border-green-200'
            : 'bg-red-50 text-red-800 border border-red-200'
        }`;
        div.textContent = message;
        div.classList.remove('hidden');

        setTimeout(() => div.classList.add('hidden'), 5000);
      }

      // Load tenants on page load
      loadTenants();
    </script>
  </body>
</html>
