# üîç Complete Function Call Flow Analysis: booking-cancel

## Overview
This document traces a complete function call from Retell agent through your Express middleware, routes, controllers, services, and finally to the Square API.

---

## ‚ö° STEP-BY-STEP FLOW

### **Step 1: Retell Agent Makes Tool Call**
```
Retell Agent Tool: booking-cancel
‚îú‚îÄ Sends HTTP request
‚îú‚îÄ POST/DELETE /api/bookings/:bookingId
‚îú‚îÄ Headers:
‚îÇ  ‚îú‚îÄ X-Retell-API-Key: <RETELL_API_KEY>
‚îÇ  ‚îú‚îÄ Content-Type: application/json
‚îÇ  ‚îî‚îÄ (NO X-Agent-ID header - Retell can't pass custom headers in tool defs)
‚îî‚îÄ Body: { "bookingId": "..." }
```

**Current Status**: ‚úÖ Ready to receive request

---

### **Step 2: Express Server Receives Request**
```
File: src/express-app.js
‚îú‚îÄ Server listening on :3000
‚îú‚îÄ Request enters middleware chain
‚îî‚îÄ Hits /api/bookings/:bookingId route
```

---

### **Step 3: Route Handler (FIRST CHECK - MIDDLEWARE CHAIN)**
```
File: src/routes/bookings.js (Lines 1-82)
‚îú‚îÄ Routes defined: GET, POST, DELETE for /api/bookings/:bookingId
‚îú‚îÄ Middleware stack (IN ORDER):
‚îÇ  ‚îú‚îÄ 1Ô∏è‚É£  correlationId middleware ‚Üí Generates req.correlationId
‚îÇ  ‚îú‚îÄ 2Ô∏è‚É£  agentAuth middleware ‚Üí ‚ö†Ô∏è CRITICAL AUTHENTICATION STEP
‚îÇ  ‚îú‚îÄ 3Ô∏è‚É£  validateContentType middleware
‚îÇ  ‚îî‚îÄ 4Ô∏è‚É£  Controller handler
‚îî‚îÄ For DELETE: Calls bookingController.cancelBooking()
```

**Route Definition (Line 52-54):**
```javascript
router.delete('/:bookingId', asyncHandler(bookingController.cancelBooking));
```

---

### **Step 4: AUTHENTICATION MIDDLEWARE - agentAuth**
```
File: src/middlewares/agentAuth.js (Lines 1-108)

EXECUTION PATH FOR RETELL AGENT:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

1. Extract Headers:
   ‚îú‚îÄ authHeader = req.headers['authorization']       ‚Üí undefined
   ‚îú‚îÄ agentId = req.headers['x-agent-id']            ‚Üí undefined
   ‚îî‚îÄ retellApiKey = req.headers['x-retell-api-key']  ‚Üí "YOUR_KEY_VALUE"

2. CHECK 1 (Lines 28-43): RETELL_API_KEY Auth ‚úÖ
   if (retellApiKey === process.env.RETELL_API_KEY) {
       Create tenantContext = {
           id: 'retell-agent',
           agentId: 'retell-agent',
           accessToken: process.env.SQUARE_ACCESS_TOKEN,      ‚Üê ‚úÖ ESSENTIAL
           locationId: process.env.SQUARE_LOCATION_ID,        ‚Üê ‚úÖ ESSENTIAL
           squareAccessToken: process.env.SQUARE_ACCESS_TOKEN,
           squareLocationId: process.env.SQUARE_LOCATION_ID,
           timezone: process.env.TZ,
           environment: process.env.SQUARE_ENVIRONMENT,
           authenticated: true,
           isRetellAgent: true
       }
       
       req.retellContext = tenantContext  ‚Üê For retell-specific code
       req.tenant = tenantContext         ‚Üê ‚úÖ FOR CONTROLLER COMPATIBILITY
       return next() ‚Üí Proceed to controller
   }

3. CHECK 2 (Lines 46-51): Standard Bearer Token Auth (SKIPPED)
   if (!authHeader || !agentId) {
       ‚Üí return 401 error
   }
```

**What Gets Set on Request Object:**
- ‚úÖ `req.correlationId` - Correlation ID from previous middleware
- ‚úÖ `req.tenant` - Tenant context with Square credentials
- ‚úÖ `req.tenant.accessToken` - Square access token (CRITICAL)
- ‚úÖ `req.tenant.locationId` - Square location ID (CRITICAL)

**Potential Gaps Here:**
1. ‚ö†Ô∏è Missing environment variables will cause failure
2. ‚ö†Ô∏è X-Retell-API-Key header must match RETELL_API_KEY exactly
3. ‚ö†Ô∏è SQUARE_ACCESS_TOKEN must be valid
4. ‚ö†Ô∏è SQUARE_LOCATION_ID must be valid

---

### **Step 5: Controller Handler**
```
File: src/controllers/bookingController.js (Lines 564-649)

FUNCTION: cancelBooking(req, res)

1. Extract context from req:
   const { correlationId, tenant } = req
   ‚îî‚îÄ ‚úÖ tenant has: accessToken, locationId
   
2. Extract bookingId:
   const query = req.query || {}
   const bookingId = req.params.bookingId || req.params.id || query.bookingId
   ‚îî‚îÄ ‚úÖ Should be in URL: /api/bookings/:bookingId
   
3. Validation (Line 575-580):
   if (!bookingId) {
       return res.status(400).json({ error: 'bookingId is required' })
   }
   
4. Create Azure Functions Context Mock:
   const context = {
       log: (...args) => logger.info(...args),
       error: (...args) => logger.error(...args)
   }
   
5. Call Helper (Line 624-633):
   const { cancelBooking: cancelBookingHelper } = 
       require('../utils/helpers/bookingHelpers')
   
   const result = await cancelBookingHelper(context, tenant, bookingId)
   ‚îî‚îÄ ‚úÖ Passes tenant with Square credentials
   
6. Clean BigInt Response (Line 638-641):
   const cleanedBooking = cleanBigIntFromObject(result.booking)
   
7. Return Success (Line 643-649):
   return res.status(200).json({
       success: true,
       data: { booking: cleanedBooking },
       message: 'Booking cancelled successfully'
   })
```

**Potential Gaps Here:**
1. ‚ö†Ô∏è Booking ID extraction from multiple sources - could be confusing
2. ‚ö†Ô∏è No validation that bookingId format is correct
3. ‚ö†Ô∏è Error handling might mask actual errors

---

### **Step 6: Booking Helper Layer**
```
File: src/utils/helpers/bookingHelpers.js (892 lines)

FUNCTION: cancelBooking(context, tenant, bookingId)

1. Create Square Client:
   const { square } = require('../squareUtils')
   
   OR more explicitly:
   const client = createSquareClient(
       tenant.accessToken,      ‚Üê Uses tenant.accessToken ‚úÖ
       tenant.locationId        ‚Üê Uses tenant.locationId ‚úÖ
   )
   
2. Call Square API:
   await square.bookingsApi.cancelBooking({
       bookingId: bookingId,
       version: bookingVersion,
       idempotencyKey: generateIdempotencyKey()
   })
   
3. Return formatted response:
   return {
       booking: result.result.booking  ‚Üê Square SDK v42+ structure
   }
```

**This is where the actual API call happens:**
```javascript
// Pseudo code flow:
const client = createSquareClient(tenant.accessToken, tenant.locationId)
const response = await client.bookingsApi.cancelBooking({...})
```

---

### **Step 7: Square API Call**
```
Square SDK makes HTTP request:
POST https://connect.squareupsandbox.com/v2/bookings/{booking_id}/cancel

Headers:
‚îú‚îÄ Authorization: Bearer <square_access_token>
‚îú‚îÄ User-Agent: squareupsdk/js-v42.0.0
‚îú‚îÄ Content-Type: application/json
‚îî‚îÄ X-Square-User-Agent: squareupsdk/js-v42.0.0

Sent from: req.tenant.accessToken (Retell auth path)

Response:
‚îú‚îÄ 200 OK: { booking: {...} }
‚îú‚îÄ 400: Invalid request
‚îú‚îÄ 401: Invalid access token ‚Üê ‚ö†Ô∏è Would indicate bad SQUARE_ACCESS_TOKEN
‚îú‚îÄ 404: Booking not found
‚îî‚îÄ 429: Rate limited
```

---

### **Step 8: Response Flow (Reverse)**
```
Square API Response
    ‚Üì
Booking Helper (Line 6)
    ‚îú‚îÄ Extract: result.result.booking
    ‚îú‚îÄ Log: cancel_booking_success
    ‚îî‚îÄ Return: { booking: {...} }
    ‚Üì
Controller (Line 638-649)
    ‚îú‚îÄ Clean BigInt: cleanBigIntFromObject()
    ‚îî‚îÄ Return: 200 JSON response
    ‚Üì
Express Response
    ‚îú‚îÄ Status: 200
    ‚îú‚îÄ Body: { success, data, message, timestamp }
    ‚îî‚îÄ Sent to Retell Agent
    ‚Üì
Retell Agent
    ‚îî‚îÄ Processes tool call result
```

---

## üö® IDENTIFIED GAPS & ISSUES

### **Gap 1: Missing X-Retell-API-Key Header**
**Location:** Step 4 (Auth Middleware)
**Issue:** Retell agent tool calls don't include X-Retell-API-Key header
**Current Code Check:**
```javascript
if (retellApiKey && retellApiKey === process.env.RETELL_API_KEY) {
    // Only works if header is present
}
```
**Status:** ‚úÖ FIXED (middleware ready)
**Action Needed:** Configure Retell tools in dashboard to include header

---

### **Gap 2: Missing Environment Variables**
**Location:** Step 4 (Auth Middleware, Lines 35-36)
**Issue:** If SQUARE_ACCESS_TOKEN or SQUARE_LOCATION_ID are undefined:
```javascript
const tenantContext = {
    accessToken: process.env.SQUARE_ACCESS_TOKEN,    // ‚Üê Could be undefined
    locationId: process.env.SQUARE_LOCATION_ID,      // ‚Üê Could be undefined
}
```
**Current Status:** ‚ö†Ô∏è POTENTIAL ISSUE
**Impact:** Square API calls will fail with 401/invalid credentials
**Check With:**
```bash
az webapp config appsettings list \
  --resource-group square-middleware-prod-rg \
  --name square-middleware-prod-api | grep -E "SQUARE_ACCESS_TOKEN|SQUARE_LOCATION_ID|RETELL_API_KEY"
```

---

### **Gap 3: Tenant Object Not Set on Controller Level**
**Location:** Step 5 (Controller)
**Issue (RESOLVED):** Previously, controllers expected `req.tenant` but auth middleware only set `req.retellContext`
**Previous Code:**
```javascript
// BEFORE FIX:
req.retellContext = tenantContext  // ‚Üê Only this was set
// Controllers expected:
const { tenant } = req  // ‚Üê Would be undefined
```
**Current Status:** ‚úÖ FIXED
**Current Code:**
```javascript
// AFTER FIX:
req.retellContext = tenantContext
req.tenant = tenantContext  // ‚Üê Both set now ‚úÖ
```

---

### **Gap 4: No Validation of Booking ID Format**
**Location:** Step 5 (Controller, Lines 575-580)
**Issue:** Accepts any string as bookingId, no format validation
```javascript
const bookingId = req.params.bookingId || req.params.id || query.bookingId
if (!bookingId) {
    // Only checks if empty, not if format is valid
}
```
**Impact:** Invalid booking IDs might be sent to Square API
**Suggestion:** Add format validation:
```javascript
if (!bookingId || !/^[A-Za-z0-9_-]{10,}$/.test(bookingId)) {
    return res.status(400).json({ error: 'Invalid bookingId format' })
}
```

---

### **Gap 5: Duplicate cancelBooking Function Paths**
**Location:** Steps 5 & 6
**Issue:** Three separate implementations:
1. **Express Handler** (`cancelBooking` - Line 564)
   - Calls `cancelBookingHelper`
   - Creates Azure context
   
2. **Handler Function** (`handleCancelBooking` - Line 1144)
   - Also calls `cancelBookingHelper`
   - Used by `manageBooking` route
   
3. **Helper Function** (`cancelBookingHelper` - bookingHelpers.js)
   - Actually calls Square API

**Potential Issue:** Path 1 vs Path 2 inconsistency
```javascript
// PATH 1 (Direct route):
DELETE /api/bookings/:bookingId
    ‚Üí cancelBooking()
    ‚Üí cancelBookingHelper(context, tenant, bookingId)
    
// PATH 2 (Manager route):
DELETE /api/booking/cancel?bookingId=...
    ‚Üí manageBooking()
    ‚Üí handleCancelBooking()
    ‚Üí cancelBookingHelper(context, bookingId)  ‚Üê ‚ö†Ô∏è Different args!
```

**Current Status:** ‚ö†Ô∏è INCONSISTENCY
**Issue:** Path 2 passes `context, bookingId` but Path 1 passes `context, tenant, bookingId`

---

### **Gap 6: Error Handling Not Comprehensive**
**Location:** Step 5 & 8 (Controller error handling, Lines 596-612)
**Issue:** Generic error messages don't surface real Square API errors
```javascript
catch (error) {
    // Only catches specific strings:
    if (error.message.includes('not found')) { ... }
    if (error.message.includes('authentication failed')) { ... }
    // Everything else returns 500 with generic message
}
```
**Potential Issue:** 401 errors from Square won't be clearly identified
**Suggestion:** Add more specific error handling:
```javascript
if (error.statusCode === 401) {
    return res.status(401).json({
        success: false,
        message: 'Authentication failed with Square API',
        error: error.message,
        debug: { accessTokenLength: tenant.accessToken?.length }
    })
}
```

---

### **Gap 7: No Request/Response Logging at Square API Level**
**Location:** Step 7 (Square API call)
**Issue:** When Square API calls fail, there's no detailed logging of:
- What was sent to Square
- What Square returned
- Headers sent
- Rate limiting info

**Suggestion:** Add logging in bookingHelpers.js:
```javascript
const logApiCall = (method, endpoint, statusCode, body) => {
    console.log(`üì° [SQUARE API] ${method} ${endpoint} ‚Üí ${statusCode}`)
    console.log(`üì¶ Response:`, body)
}
```

---

### **Gap 8: Correlation ID Not Threaded Through Service Layers**
**Location:** Steps 5-7
**Issue:** correlationId is created but not passed to Square API calls
```javascript
// Step 5: Has correlationId
const { correlationId, tenant } = req

// Step 6: Calls helper but helpers don't receive correlationId
const result = await cancelBookingHelper(context, tenant, bookingId)
                                         // ‚Üë No correlationId passed

// Step 7: Square API call has no correlation ID
```

**Impact:** Can't trace Square API calls back to original Retell requests
**Suggestion:** Pass correlationId through entire chain:
```javascript
const result = await cancelBookingHelper(context, tenant, bookingId, correlationId)
```

---

## üìä FLOW DIAGRAM

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          RETELL AGENT TOOL CALL                             ‚îÇ
‚îÇ                    DELETE /api/bookings/:bookingId                          ‚îÇ
‚îÇ              Header: X-Retell-API-Key: <RETELL_API_KEY>                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    MIDDLEWARE CHAIN (src/routes/bookings.js)                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 1. correlationId middleware                                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îî‚îÄ Sets: req.correlationId                                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚îÇ                                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 2. agentAuth middleware (src/middlewares/agentAuth.js)   [CRITICAL] ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îî‚îÄ Checks: X-Retell-API-Key === process.env.RETELL_API_KEY       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îî‚îÄ Creates: tenantContext with Square credentials                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îî‚îÄ Sets: req.tenant = tenantContext ‚úÖ ESSENTIAL                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îî‚îÄ Sets: req.retellContext = tenantContext (for compatibility)   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚ö†Ô∏è  GAPS:                                                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - SQUARE_ACCESS_TOKEN env var must exist                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - SQUARE_LOCATION_ID env var must exist                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - X-Retell-API-Key header must be configured in Retell console   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚îÇ                                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 3. validateContentType, validation middlewares                       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              CONTROLLER HANDLER (src/controllers/bookingController.js)      ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îÇ  Function: cancelBooking(req, res)                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Extract: { correlationId, tenant } = req                               ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ ‚úÖ req.tenant.accessToken (from auth middleware)                    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ ‚úÖ req.tenant.locationId (from auth middleware)                     ‚îÇ
‚îÇ  ‚îÇ                                                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Extract: bookingId from URL params                                     ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ ‚ö†Ô∏è No format validation                                             ‚îÇ
‚îÇ  ‚îÇ                                                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Create: Azure Functions context mock                                   ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ For compatibility with helpers                                      ‚îÇ
‚îÇ  ‚îÇ                                                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Call: cancelBookingHelper(context, tenant, bookingId)                 ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Passes tenant with Square credentials ‚úÖ                            ‚îÇ
‚îÇ  ‚îÇ                                                                          ‚îÇ
‚îÇ  ‚îú‚îÄ ‚ö†Ô∏è GAPS:                                                               ‚îÇ
‚îÇ  ‚îÇ  - No validation of bookingId format                                    ‚îÇ
‚îÇ  ‚îÇ  - No detailed error logging                                           ‚îÇ
‚îÇ  ‚îÇ  - correlationId not passed through to Square                          ‚îÇ
‚îÇ  ‚îÇ  - Three different code paths (Path 1: direct, Path 2: manager)       ‚îÇ
‚îÇ  ‚îî‚îÄ Return: 200 JSON response with cleaned booking data                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            BOOKING SERVICE/HELPER (src/utils/helpers/bookingHelpers.js)     ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îÇ  Function: cancelBooking(context, tenant, bookingId)                        ‚îÇ
‚îÇ  ‚îú‚îÄ Create: Square Client                                                  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Uses: tenant.accessToken ‚úÖ                                          ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Uses: tenant.locationId ‚úÖ                                           ‚îÇ
‚îÇ  ‚îÇ                                                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Call: square.bookingsApi.cancelBooking({...})                          ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Sends: idempotencyKey for idempotency                              ‚îÇ
‚îÇ  ‚îÇ                                                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Handle: Square API response                                            ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Extract: result.result.booking (SDK v42+ structure)                ‚îÇ
‚îÇ  ‚îÇ                                                                          ‚îÇ
‚îÇ  ‚îî‚îÄ Return: { booking: {...} }                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SQUARE API (External Service)                            ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îÇ  POST https://connect.squareupsandbox.com/v2/bookings/{booking_id}/cancel  ‚îÇ
‚îÇ  ‚îú‚îÄ Authorization: Bearer <square_access_token>                            ‚îÇ
‚îÇ  ‚îú‚îÄ ‚ö†Ô∏è GAPS:                                                               ‚îÇ
‚îÇ  ‚îÇ  - No detailed logging of API response                                  ‚îÇ
‚îÇ  ‚îÇ  - No correlation ID in request                                         ‚îÇ
‚îÇ  ‚îÇ  - Limited error handling for 401/403/429                               ‚îÇ
‚îÇ  ‚îî‚îÄ Response: 200 OK { booking: {...} }                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      RESPONSE FLOW (Reverse)                                ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îÇ  Helper ‚Üí cleanBigIntFromObject()                                           ‚îÇ
‚îÇ          ‚îÇ                                                                   ‚îÇ
‚îÇ          ‚ñº                                                                   ‚îÇ
‚îÇ  Controller ‚Üí 200 JSON { success, data, message, timestamp }               ‚îÇ
‚îÇ          ‚îÇ                                                                   ‚îÇ
‚îÇ          ‚ñº                                                                   ‚îÇ
‚îÇ  Express Response ‚Üí HTTP 200                                               ‚îÇ
‚îÇ          ‚îÇ                                                                   ‚îÇ
‚îÇ          ‚ñº                                                                   ‚îÇ
‚îÇ  Retell Agent ‚Üê Tool call result                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ VERIFICATION CHECKLIST

### **Pre-Call Verification**
- [ ] `RETELL_API_KEY` is set in Azure App Service
- [ ] `SQUARE_ACCESS_TOKEN` is valid
- [ ] `SQUARE_LOCATION_ID` is valid
- [ ] `X-Retell-API-Key` header configured in Retell tool definition
- [ ] Booking ID is valid and exists in Square

### **During Call Monitoring**
- [ ] Check logs for "Agent config lookup failed" (expected, non-blocking)
- [ ] Check for "Missing or invalid Authorization header" (would indicate auth failure)
- [ ] Check for Square API 401 (would indicate credential issue)
- [ ] Check for "Booking cancelled successfully" (success message)

### **Post-Call Verification**
- [ ] Booking status changed to CANCELLED in Square
- [ ] Response timestamp included
- [ ] Correlation ID tracked in logs

---

## üîß RECOMMENDED IMPROVEMENTS

### **Priority 1: Add Booking ID Validation**
```javascript
// In cancelBooking controller (line ~575)
const bookingIdRegex = /^[A-Za-z0-9_-]{10,}$/
if (!bookingId || !bookingIdRegex.test(bookingId)) {
    return res.status(400).json({ 
        error: 'Invalid booking ID format' 
    })
}
```

### **Priority 2: Improve Error Handling for Square API**
```javascript
// In error catch block (line ~596)
if (error.response?.status === 401) {
    return res.status(401).json({
        error: 'Square API authentication failed',
        debug: {
            hasAccessToken: !!tenant.accessToken,
            tokenLength: tenant.accessToken?.length
        }
    })
}
```

### **Priority 3: Thread Correlation ID Through All Layers**
```javascript
// In bookingHelpers.js
const result = await cancelBookingHelper(
    context, 
    tenant, 
    bookingId, 
    correlationId  // Add this
)
```

### **Priority 4: Add Detailed API Request/Response Logging**
```javascript
// In bookingHelpers.js before Square API call
console.log(`üì° [SQUARE API] Cancelling booking:`, {
    bookingId,
    accessTokenLength: tenant.accessToken.length,
    locationId: tenant.locationId,
    correlationId
})
```

---

## üéØ CONCLUSION

The function call flow is **mostly sound** with a few identified gaps:

‚úÖ **Working Well:**
- Multi-layer middleware authentication
- Tenant context properly propagated
- Both X-Retell-API-Key and Bearer token auth supported
- BigInt response cleaning

‚ö†Ô∏è **Needs Attention:**
1. Environment variables must be set correctly
2. X-Retell-API-Key header must be configured in Retell console
3. Booking ID format validation missing
4. Error handling could be more specific
5. Correlation ID not threaded through all layers

üöÄ **Next Steps:**
1. Verify environment variables are set: `az webapp config appsettings list`
2. Configure X-Retell-API-Key in Retell tool definitions
3. Test with a booking-cancel call and monitor logs
4. Implement recommended improvements for better reliability
